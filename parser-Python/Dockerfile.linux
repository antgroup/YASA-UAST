# ================================
# å¤šé˜¶æ®µæ„å»ºï¼šåŸºäº manylinux2014 (glibc 2.17+) + Miniforge
# ================================
FROM quay.io/pypa/manylinux2014_x86_64 AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä¼ é€’æ„å»ºå‚æ•°ï¼ˆç”¨äºè·¨å¹³å°ç¼–è¯‘ï¼Œæœ¬ä¾‹ä¸­å›ºå®šä¸º linux/amd64ï¼‰
ARG GOOS=linux
ARG GOARCH=amd64
RUN echo "ğŸ— Building for $GOOS/$GOARCH"

# -------------------------------
# å®‰è£… Miniforge
# -------------------------------
ENV MAMBA_ROOT_PREFIX=/opt/conda
ENV PATH=/opt/conda/bin:${PATH}

# ä¸‹è½½å¹¶å®‰è£… Miniforge
RUN curl -L -o miniforge.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh && \
    bash miniforge.sh -b -p /opt/conda && \
    rm miniforge.sh && \
    conda clean --all

# åˆ›å»º Python 3.13 ç¯å¢ƒå¹¶å®‰è£… PyInstaller
RUN conda create -n py313 python=3.13 -y && \
    /opt/conda/envs/py313/bin/pip install pyinstaller

# æ¿€æ´» py313 ç¯å¢ƒä¸ºé»˜è®¤
ENV CONDA_DEFAULT_ENV=py313
ENV PATH=/opt/conda/envs/py313/bin:$PATH

# -------------------------------
# å¤åˆ¶æºç  & å®‰è£…ä¾èµ–
# -------------------------------
COPY parser-Python/ ./

RUN pip install -r requirements.txt

# -------------------------------
# ä½¿ç”¨ PyInstaller æ‰“åŒ…
# -------------------------------
RUN pyinstaller --onefile uast/builder.py

# éªŒè¯è¾“å‡ºæ˜¯å¦å­˜åœ¨
RUN if [ ! -f "dist/builder" ]; then \
        echo "âŒ ERROR: dist/builder was not created!" >&2; \
        exit 1; \
    fi && \
    echo "âœ… Successfully built binary at /app/dist/builder"

# ================================
# ç¬¬äºŒé˜¶æ®µï¼šè½»é‡è¿è¡Œé•œåƒï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
# ================================
FROM quay.io/pypa/manylinux2014_x86_64

WORKDIR /dist
# ä» builder é˜¶æ®µå¤åˆ¶æœ€ç»ˆäºŒè¿›åˆ¶
COPY --from=builder /app/dist/builder ./uast4py-linux-amd64
RUN chmod +x uast4py-linux-amd64

CMD ["echo", "Build complete"]
