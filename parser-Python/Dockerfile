# ================================
# å¤šé˜¶æ®µæ„å»ºï¼šåŸºäº manylinux2014 (glibc 2.17+) + Miniforge
# ================================
FROM quay.io/pypa/manylinux2014_x86_64 AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä¼ é€’æ„å»ºå‚æ•°
ARG GOOS=linux
ARG GOARCH=amd64

# æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä¼ å‚
RUN echo "ğŸ— Building for $GOOS/$GOARCH"

# -------------------------------
# å®‰è£… Miniforge
# -------------------------------
ENV MAMBA_ROOT_PREFIX=/opt/conda
ENV PATH=/opt/conda/bin:${PATH}

RUN curl -L -o miniforge.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh && \
    bash miniforge.sh -b -p /opt/conda && \
    rm miniforge.sh && \
    conda clean --all

# æ¥å—è®¸å¯å¹¶åˆ›å»ºç¯å¢ƒ
RUN conda init bash && \
    echo "conda activate base" >> ~/.bashrc && \
    conda create -n py313 python=3.13 -y && \
    /opt/conda/envs/py313/bin/pip install pyinstaller

# æ¿€æ´» py313 ç¯å¢ƒä¸ºé»˜è®¤
ENV CONDA_DEFAULT_ENV=py313
ENV PATH=/opt/conda/envs/py313/bin:$PATH

# -------------------------------
# å¤åˆ¶æºç  & å®‰è£…ä¾èµ–
# -------------------------------
# â— ä¿®æ”¹ç‚¹ï¼šä¸å† COPY parser-Pythonï¼Œè€Œæ˜¯ç›´æ¥å¤åˆ¶ . åˆ° /app
COPY . .

RUN pip install -r requirements.txt

# -------------------------------
# ä½¿ç”¨ PyInstaller æ‰“åŒ…
# -------------------------------
RUN pyinstaller --onefile uast/builder.py

# ===============================
# ç¬¬äºŒé˜¶æ®µï¼šç²¾ç®€é•œåƒ
# ===============================
FROM quay.io/pypa/manylinux2014_x86_64

WORKDIR /dist

# ä» builder é˜¶æ®µå¤åˆ¶æ‰“åŒ…å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶
COPY --from=builder /app/dist/builder ./uast4py-linux-amd64

# æ·»åŠ å¯æ‰§è¡Œæƒé™
RUN chmod +x uast4py-linux-amd64

# æç¤ºæ„å»ºå®Œæˆï¼ˆå¯æ›¿æ¢ä¸ºå®é™…å‘½ä»¤ï¼‰
CMD ["echo", "âœ… Build complete! Binary: /dist/uast4py-linux-amd64"]
